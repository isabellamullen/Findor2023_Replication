---
title: "replication_study3_alternatemodel"
output: pdf_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(rio)
library(dplyr)
library(PerformanceAnalytics)
library(kableExtra)
library(psych)
library(ggplot2)
library(jmv)
library(magick)
library(report)
library(reshape2)
library(ordinal)
library(RVAideMemoire)
library(emmeans)
library(effectsize)
library(repmod)
library(MANOVA.RM)
library(ggrepel)
library(matrixTests)
library(tidyverse)
library(lessR)
library(rstatix)
library(multcomp)
library(jtools)
library(sjPlot)
library(generalhoslem)
library(effects)
library(lmtest)

#added
library(ggdist)



set.seed(42)

options(scipen=999, digits=3)

#This function concatenates multiple vectors element-wise while handling NA values by replacing them with empty strings.
#Works like paste(), but ensures that NA values are treated as missing (not "NA" as paste() would normally do).
#Removes unnecessary spaces or separators from the output.
#Converts empty results back to NA.

paste_na <- function(..., sep = " ") {
  L <- list(...)
  L <- lapply(
    L,
    function(x) {
      x[is.na(x)] <- ""
      x
    }
  )
  out <- gsub(
    paste0("(^", sep, "|", sep, "$)"), "",
    gsub(
      paste0(sep, sep), sep,
      do.call(paste, c(L, list(sep = sep)))
    )
  )
  is.na(out) <- out == ""
  return(out)
}


```
# Study 3 {.tabset}
## Data {.tabset}
### Data load
```{r}
s3 <- import("../original_materials/data/Study3.sav")
```

### Data prep
```{r, message=FALSE, results='hide'}
s3$group= factor(s3$SKUPINA, levels = c(1, 2,3,4), labels = c("Control","Equality", "Proportionality", "Need"))
s3$SEX <- factor(s3$SEX, levels = c(1, 2), labels = c("Male","Female"))
s3$AGECAT= factor(s3$AGECAT, levels = c(1,2,3,4,5,6), labels = c("18-24","25-34","35-44", "45-54","55-64","65+"))
s3$EDU= factor(s3$EDU, levels = c(1, 2,3,4), labels = c("Primary","Secondary (no diploma)","Secondary (complete)", "University"))
s3$SIZE= factor(s3$SIZE, levels = c(1, 2,3,4,5), labels = c("less than 1k","1k-4 999","5k-19 999", "20k - 99 999","100k+"))
s3$REG= factor(s3$REG, levels = c(1, 2,3,4,5,6,7,8), labels = c("Bratislavsky","Trnavsky","Trenciansky", "Nitriansky","Zilinsky","Banskobystricky","Presovsky","Kosicky"))


s3$income <- car::recode(s3$PINCOME,"'1'='below median';'2'='below median';'8'='NA';'9'='NA'; else = 'above median'")
```

```{r}
# Checking the data types of the dataset
str(s3)
```

### Original Model

```{r}
s3$E1 <- as.ordered(s3$E1)
s3$E2 <- as.ordered(s3$E2)
s3$E3 <- as.ordered(s3$E3)
s3$E4 <- as.ordered(s3$E4)

s3personal  <- polr(E3 ~ group, data = s3, Hess=TRUE)
summary(s3personal)
ctable <- coef(summary(s3personal))
p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
(ctable <- cbind(ctable, "p value" = p))
ci <- confint(s3personal)
exp(cbind(OR = coef(s3personal), ci))
```


### Alternate Model

```{r}
s3personal_probit <- polr(E3 ~ group + AGE + EDU + SEX + REG, data = s3,
                          Hess=TRUE)
summary(s3personal_probit)
ctable <- coef(summary(s3personal_probit))
p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
(ctable <- cbind(ctable, "p value" = p))
ci <- confint(s3personal_probit)
exp(cbind(OR = coef(s3personal_probit), ci))
```

### Original Model - Releved to Proportionality

```{r}
s3$group <- relevel(s3$group, ref = "Proportionality")
s3personal_prop  <- polr(E3 ~ group, data = s3, Hess=TRUE)
summary(s3personal_prop)
ctable <- coef(summary(s3personal_prop))
p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
(ctable <- cbind(ctable, "p value" = p))
ci <- confint(s3personal_prop)
exp(cbind(OR = coef(s3personal_prop), ci))
```

### Alternate Model - Releved to Proportionality

```{r}
s3personal_probit_prop <- polr(E3 ~ group + AGE + EDU + SEX + REG, data = s3,
                          Hess=TRUE)
summary(s3personal_probit_prop)
ctable <- coef(summary(s3personal_probit_prop))
p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
(ctable <- cbind(ctable, "p value" = p))
ci <- confint(s3personal_probit_prop)
exp(cbind(OR = coef(s3personal_probit_prop), ci))
```

```{r}
# This test is an indicator of whether we have used an appropriate model to
# explain the data. The p-value > 0.05 confirms for us a good fit for our model.
print(lipsitz.test(s3personal))
print(lipsitz.test(s3personal_probit))
```

#### Confusion Tables

```{r}
# Original Model
predict_orig <-  predict(s3personal, s3)
cTab_orig <- table(s3$E3, predict_orig)
print(cTab_orig)

# Alternate Model
predict_alter <-  predict(s3personal_probit, s3)
cTab_alter <- table(s3$E3, predict_alter)
cTab_alter
```

#### (In-sample Performance) Confusion Matrix and Accuracy

```{r}
# Predicted classes
pred_logit <- predict(s3personal, type = "class")
pred_probit <- predict(s3personal_probit, type = "class")

# Confusion matrices
table(pred_logit, s3$E3)
table(pred_probit, s3$E3)

# Accuracy calculation
mean(pred_logit == factor(s3$E3, ordered = FALSE))
mean(pred_probit == factor(s3$E3, ordered = FALSE))
```

#### (In-sample Performance) ROC Curve

```{r}
library(pROC)

# Probabilities for each class
prob_logit <- predict(s3personal, type = "prob")
prob_probit <- predict(s3personal_probit, type = "prob")

# Creating ROC curves for multiple classes
roc_logit <- roc(s3$E3, prob_logit[, 2])
roc_probit <- roc(s3$E3, prob_probit[, 2])

plot(roc_logit, col = "blue", main = "ROC Curve Comparison")
plot(roc_probit, col = "red", add = TRUE)
legend("bottomright", legend = c("Logit", "Probit"), col = c("blue", "red"), lwd = 2)
```

#### (In-sample Performance) AIC and BIC

```{r}
# AIC comparison
AIC(s3personal, s3personal_probit)

# BIC comparison
BIC(s3personal, s3personal_probit)
```

#### (In-sample Performance) Observed vs. Predicted Probability Plot

```{r}
library(ggplot2)

# Predicted probabilities
prob_logit <- predict(s3personal, type = "prob")
prob_probit <- predict(s3personal_probit, type = "prob")

# Combine data for plotting
calibration_data <- data.frame(
  Observed = as.numeric(s3$E3),
  Predicted_Logit = prob_logit[, 2],
  Predicted_Probit = prob_probit[, 2]
)

# Plot
ggplot(calibration_data, aes(x = Observed)) +
  geom_point(aes(y = Predicted_Logit, color = "Logit")) +
  geom_point(aes(y = Predicted_Probit, color = "Probit")) +
  geom_smooth(aes(y = Predicted_Logit, color = "Logit"), method = "loess", se = FALSE) +
  geom_smooth(aes(y = Predicted_Probit, color = "Probit"), method = "loess", se = FALSE) +
  labs(title = "Calibration Plot", x = "Observed Outcome", y = "Predicted Probability") +
  scale_color_manual(values = c("Logit" = "blue", "Probit" = "red"))
```

#### (In-sample Performance) Log-likelihood Ratio Test

```{r}
lrtest(s3personal, s3personal_probit)
```

#### (Out-of-sample Performance) K-fold Cross-Validation

```{r}
library(caret)

# Cross-validation control
ctrl <- trainControl(method = "cv", number = 10)

# Fit models with cross-validation
logit_cv <- train(E3 ~ group, data = s3, method = "polr", trControl = ctrl)
probit_cv <- train(E3 ~ group + AGE + SEX + EDU + REG, data = s3,
                   method = "polr", trControl = ctrl)

# Model performance
print(logit_cv)
print(probit_cv)
```

```{r}
# # Compare resampling results
# resamples <- resamples(list(general = logit_cv, restricted = probit_cv))
# summary(resamples)
```

#### (Out-of-Sample Performance) Mean Squared Error

```{r}
# MSE calculation
mse_logit <- mean((prob_logit_test - model.matrix(~ E3 - 1, data = test_data))^2)
mse_probit <- mean((prob_probit_test - model.matrix(~ E3 - 1, data = test_data))^2)

mse_logit
mse_probit
```

#### (Independent Variable Effects)

```{r, fig.width=6, fig.height=8}
plot(Effect(focal.predictors = "AGE", s3personal_probit))
```

```{r}
# This function gets the most often repeating factor value in a column
mode_fctr <- function(x) levels(x)[which.max(tabulate(match(x, levels(x))))]

# This function gets the most often repeating value in a column
mode_char <- function(x) unique(x)[which.max(tabulate(match(x, unique(x))))]

levels(s3$REG)
```

#### (Quantity of Interest)

```{r, fig.width=8, fig.height=5}

s3personal_probit_prop <- polr(E3 ~ as.numeric(group) + AGE + as.numeric(EDU) +
                                 as.numeric(SEX) + as.numeric(REG), data = s3,
                          Hess=TRUE)

# We create a scenario where we look at the following for the Bratislavsky and
# Zilinsky regions
# Median AGE
# Most often repeating (mode) EDU
# Most often repeating (mode) SEX
# REG = 1/5 (Bratislavsky/Zilinsky)

X.low<-c(group = mode_char(as.numeric(filter(s3, REG == "Bratislavsky")$group)), 
         AGE = median(filter(s3, REG == "Bratislavsky")$AGE),
         EDU = mode_char(as.numeric(filter(s3, REG == "Bratislavsky")$EDU)),
         SEX = mode_char(as.numeric(filter(s3, REG == "Bratislavsky")$SEX)),
         REG = 1) #REG=Bratislavsky

X.high<-c(group = mode_char(as.numeric(filter(s3, REG == "Zilinsky")$group)),
        AGE = median(filter(s3, REG == "Zilinsky")$AGE),
        EDU = mode_char(as.numeric(filter(s3, REG == "Zilinsky")$EDU)),
        SEX = mode_char(as.numeric(filter(s3, REG == "Zilinsky")$SEX)),
        REG = 5) #REG=Zilinsky

draws<-mvrnorm(1000, #1000 draws;
               c(coef(s3personal_probit_prop),
                 s3personal_probit_prop$zeta), #note inclusion of cutpoints
               solve(s3personal_probit_prop$Hessian))

B<-draws[,1:length(coef(s3personal_probit_prop))]
Taus<-draws[,(length(coef(s3personal_probit_prop))+1):ncol(draws)]

# Predicted probabilities for coop = 1 and coop = 4
pi.class1.sc1 <- plogis(Taus[, 1] - B %*% X.low) # Pr(Y = 1)
pi.class1.sc2 <- plogis(Taus[, 1] - B %*% X.high)

pi.class2.sc1 <- plogis(Taus[, 2] - B %*% X.low) -
  plogis(Taus[, 1] - B %*% X.low) # Pr(Y = 2)
pi.class2.sc2 <- plogis(Taus[, 2] - B %*% X.high) -
  plogis(Taus[, 1] - B %*% X.high)

pi.class3.sc1 <- plogis(Taus[, 3] - B %*% X.low) -
  plogis(Taus[, 2] - B %*% X.low) # Pr(Y = 3)
pi.class3.sc2 <- plogis(Taus[, 3] - B %*% X.high) -
  plogis(Taus[, 2] - B %*% X.high)

pi.class4.sc1 <- 1 - plogis(Taus[, 3] - B %*% X.low) # Pr(Y = 4)
pi.class4.sc2 <- 1 - plogis(Taus[, 3] - B %*% X.high)

# Computing difference in probabilities
fd.class1 <- pi.class1.sc2 - pi.class1.sc1
fd.class2 <- pi.class2.sc2 - pi.class2.sc1
fd.class3 <- pi.class3.sc2 - pi.class3.sc1
fd.class4 <- pi.class4.sc2 - pi.class4.sc1

plot(density(fd.class1, adjust = 1.5),
     xlim = c(-0.8, 0.8),
     ylim = range(density(fd.class1)$y, density(fd.class2)$y, 
                  density(fd.class3)$y, density(fd.class4)$y),
     xlab = "Change in Predicted Probability",
     col = "lightgreen", bty = "n",
     yaxt = "n", lwd = 2,
     main = "Implied effect on E3 (Personal Agreement of Construction of Apartment)",
     ylab = "",
     )

lines(density(fd.class2, adjust = 1.5), col = "lightblue", lwd = 2, lty = 2)
lines(density(fd.class3, adjust = 1.5), col = "lightpink", lwd = 2, lty = 3)
lines(density(fd.class4, adjust = 1.5), col = "lightgoldenrod", lwd = 2,
      lty = 4)

legend(
  "topleft",  # Adjust x and y to move the legend
  legend = c(
    "Pr(E3 = 1 | REG = Bratislavsky - REG = Zilinsky)",
    "Pr(E3 = 2 | REG = Bratislavsky - REG = Zilinsky)",
    "Pr(E3 = 3 | REG = Bratislavsky - REG = Zilinsky)",
    "Pr(E3 = 4 | REG = Bratislavsky - REG = Zilinsky)"
  ),
  col = c("lightgreen", "lightblue", "lightpink", "lightgoldenrod"),
  lwd = 2,
  bty = "n", cex = 0.6
)
```

